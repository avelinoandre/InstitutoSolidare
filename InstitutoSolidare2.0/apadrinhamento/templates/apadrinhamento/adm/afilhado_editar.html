{% extends "shared/base_logout.html" %}
{% load static %}

{% block content %}
<div style="padding: 30px;">
    <div style="background-color: #85bce2; padding: 30px; border-radius: 20px; display: flex; gap: 30px;">

        <!-- Coluna lateral com foto -->
        <div style="width: 220px; display: flex; flex-direction: column; align-items: center; gap: 20px;">
            {% if afilhado.foto %}
                <img src="{{ afilhado.foto.url }}" alt="Foto do Afilhado" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
            {% else %}
                <p style="text-align: center; line-height: 220px; color: #999;">Sem foto</p>
            {% endif %}
        </div>

        <!-- Informações + Perguntas -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 30px;">

            <!-- Campos editáveis -->
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                    <label>Nome:
                        <input type="text" id="nome" value="{{ afilhado.nome }}" style="width: 100%;">
                    </label>
                    <label>Data de Nascimento:
                        <input type="date" id="data_nascimento" value="{{ afilhado.data_nascimento }}">
                    </label>
                </div>
            </div>

            <label>Endereço:
                <input type="text" id="endereco" value="{{ afilhado.endereco }}" style="width: 100%;">
            </label>

            <div style="display: flex; gap: 20px;">
                <label style="flex: 1;">Meu Sonho:
                    <textarea id="sonho" style="width: 100%;">{{ afilhado.sonho }}</textarea>
                </label>
            </div>

            <!-- Perguntas do questionário -->
            <div id="perguntas-container" style="display: flex; flex-direction: column; gap: 30px;">
                {% for pergunta in perguntas %}
                <div>
                    <div>{{ pergunta.pergunta }}</div>
                    <select id="resposta-{{ forloop.counter0 }}">
                        {% for opcao in pergunta.respostas %}
                            <option value="{{ forloop.counter0 }}"
                                {% if forloop.counter0 == respostas_usuario|slice:forloop.parentloop.counter0|stringformat:"d"|default:"-1" %}
                                    selected
                                {% endif %}>
                                {{ opcao }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>

            <!-- Botões de ação -->
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="salvarAfilhado({{ afilhado.id }})"
                        style="background-color: #ffd43b; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold;">
                    Alterar Dados
                </button>

                <button onclick="salvarRespostas({{ afilhado.id }})"
                        style="background-color: #ffd43b; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold;">
                    Salvar Respostas
                </button>

                <button onclick="confirmarExclusao({{ afilhado.id }})"
                        style="background-color: #ff4d4d; padding: 10px 20px; border-radius: 6px; font-weight: bold; color: white;">
                    Excluir Afilhado
                </button>
            </div>

            <!-- Alerta -->
            <div id="popup" style="display:none; margin-top: 20px; font-weight: bold;"></div>
        </div>
    </div>
</div>

<script>
function salvarAfilhado(id) {
    const data = {
        nome: document.getElementById("nome").value,
        data_nascimento: document.getElementById("data_nascimento").value,
        usuario: document.getElementById("usuario").value,
        endereco: document.getElementById("endereco").value,
        tags: document.getElementById("tags").value,
        curso: document.getElementById("curso").value,
        sonho: document.getElementById("sonho").value
    };

    fetch("{% url 'editarAfilhado' afilhado.id %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(data)
    })
    .then(resp => resp.json())
    .then(res => {
        const popup = document.getElementById("popup");
        popup.style.display = "block";
        popup.innerText = res.mensagem || "Atualizado com sucesso!";
        popup.style.color = res.sucesso ? "#155724" : "#721c24";
        popup.style.backgroundColor = res.sucesso ? "#d4edda" : "#f8d7da";
        popup.style.padding = "12px";
        popup.style.borderRadius = "8px";
    });
}

function salvarRespostas(id) {
    const selects = document.querySelectorAll('[id^="resposta-"]');
    const respostas = [];

    selects.forEach(select => respostas.push(parseInt(select.value)));

    fetch(`/adm/gerenciar-afilhados/${id}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ respostas })
    })
    .then(response => response.json())
    .then(data => {
        const popup = document.getElementById("popup");
        popup.innerText = data.mensagem || "Respostas salvas com sucesso!";
        popup.style.display = "block";
    });
}

function confirmarExclusao(id) {
    if (confirm("Tem certeza que deseja excluir este afilhado? Essa ação não poderá ser desfeita.")) {
        window.location.href = "{% url 'excluir_afilhado' afilhado.id %}";
    }
}
</script>
{% endblock %}
